name: BE/PM - PR Review Ïä¨Îûô ÏïåÎ¶º

on:
  pull_request:
    types: [review_requested, ready_for_review]
    branches:
      - main
      - 'be/**'

  pull_request_review:
    types: [submitted]
    branches:
      - main
      - 'be/**'

env:
  Dobby-Kim: "U07BJABU6G1"
  U07BJABU6G1: "BEÌåÄ ÎèÑÎπÑ"
  Chocochip101: "U07BUEJDS8G"
  U07BUEJDS8G: "BEÌåÄ Ï¥àÏΩîÏπ©"
  xogns1514: "U07AZ26UC2J"
  U07AZ26UC2J: "BEÌåÄ Îü¨Ïâ¨"
  cutehumanS2: "U07B88ZQDU4"
  U07B88ZQDU4: "BEÌåÄ ÎÉ•Ïù∏"
  HyungHoKim00: "U07B5HBKZM1"
  U07B5HBKZM1: "BEÌåÄ Î™ÖÏò§"

jobs:
  set-slack-thread:
    runs-on: ubuntu-latest
    steps:
      - name: Find Comment & Slack Thread ID
        uses: peter-evans/find-comment@v3
        id: thread-id
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-regex: '^\d{10}\.\d{6}$'
      - run: |
          echo "slack-thread-ts=${{ steps.thread-id.outputs.comment-body }}" >> "$GITHUB_OUTPUT"
    outputs:
      SLACK_THREAD_ID: ${{ steps.thread-id.outputs.slack-thread-ts }}

  review-requested_requested:
    needs: set-slack-thread
    if: github.event.action == 'review_requested'
    runs-on: ubuntu-latest
    steps:
      - name: Set reviewer and sender variables
        id: set-vars
        run: |
          echo "REVIEWER_SLACK_ID=${{ env[github.event.requested_reviewer.login] }}" >> $GITHUB_ENV 
          echo "SENDER_SLACK_ID=${{ env[github.event.sender.login] }}" >> $GITHUB_ENV

      - name: Set reviewer and sender nickname
        id: set-nicks
        run: |
          echo "REVIEWER_NICKNAME=${{ env[format('{0}', env.REVIEWER_SLACK_ID)] }}" >> $GITHUB_ENV
          echo "SENDER_NICKNAME=${{ env[format('{0}', env.SENDER_SLACK_ID)] }}" >> $GITHUB_ENV

      - name: pr review ÏöîÏ≤≠ -> Î¶¨Î∑∞Ïñ¥ÏóêÍ≤å slack Î©òÏÖò ÏïåÎ¶º
        uses: slackapi/slack-github-action@v1.26.0
        with:
          channel-id: ${{ secrets.REVIEW_MENTION_CHANNEL_ID }}
          payload: |
            {
              "thread_ts": "${{ needs.set-slack-thread.outputs.SLACK_THREAD_ID }}",
              "blocks": [
                {
                  "type": "divider"
                },
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚ú® Î¶¨Î∑∞ ÏöîÏ≤≠ ‚ú®",
                    "emoji": true
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "plain_text",
                      "text": "from.",
                      "emoji": true
                    },
                    {
                      "type": "image",
                      "image_url": "${{ github.event.sender.avatar_url }}",
                      "alt_text": ""
                    },
                    {
                      "type": "plain_text",
                      "text": "${{ env.SENDER_NICKNAME }}",
                      "emoji": true
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "‚û°Ô∏è <@${{ env.REVIEWER_SLACK_ID }}>"
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "üí°*PR Ï†úÎ™©:*\n${{ github.event.pull_request.title }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "‚ö°Ô∏è PR Î∞îÎ°úÍ∞ÄÍ∏∞ ‚ö°Ô∏è",
                        "emoji": true
                      },
                      "value": "PR_LINK",
                      "url": "${{ github.event.pull_request.html_url }}",
                      "action_id": "actionId-1"
                    }
                  ]
                },
                {
                  "type": "divider"
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

  review-submitted_alert:
    needs: set-slack-thread
    if: github.event.review.state == 'CHANGES_REQUESTED' || github.event.review.state == 'COMMENTED'
    runs-on: ubuntu-latest
    steps:
      - name: Set reviewer and reviewee variables
        id: set-vars
        run: |
          echo "REVIEWER_SLACK_ID=${{ env[github.event.sender.login] }}" >> $GITHUB_ENV
          echo "ASSIGNEE_SLACK_ID=${{ env[github.event.pull_request.assignee.login] }}" >> $GITHUB_ENV

      - name: Set reviewer and reviewee nickname
        id: set-nicks
        run: |
          echo "REVIEWER_NICKNAME=${{ env[format('{0}', env.REVIEWER_SLACK_ID)] }}" >> $GITHUB_ENV
          echo "ASSIGNEE_NICKNAME=${{ env[format('{0}', env.ASSIGNEE_SLACK_ID)] }}" >> $GITHUB_ENV

      - name: pr Î¶¨Î∑∞ submit -> assigneeÏóêÍ≤å slack Î©òÏÖò ÏïåÎ¶º
        if: env.ASSIGNEE_SLACK_ID != ''
        uses: slackapi/slack-github-action@v1.24.0
        with:
          channel-id: ${{ secrets.REVIEW_MENTION_CHANNEL_ID }}
          payload: |
            {
              "thread_ts": "${{ env.SLACK_THREAD_ID }}",
              "blocks": [
                {
                  "type": "divider"
                },
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üî•Î¶¨Î∑∞ ÏôÑÎ£åüî•",
                    "emoji": true
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "plain_text",
                      "text": "from.",
                      "emoji": true
                    },
                    {
                      "type": "image",
                      "image_url": "${{ github.event.sender.avatar_url }}",
                      "alt_text": ""
                    },
                    {
                      "type": "plain_text",
                      "text": "${{ env.REVIEWER_NICKNAME }}",
                      "emoji": true
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "‚û°Ô∏è <@${{ env.ASSIGNEE_SLACK_ID }}>"
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "üí°*PR Ï†úÎ™©:*\n${{ github.event.pull_request.title }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "‚öíÔ∏è Î∞õÏùÄ Î¶¨Î∑∞ ÌôïÏù∏ÌïòÍ∏∞ ‚öíÔ∏è",
                        "emoji": true
                      },
                      "value": "PR_LINK",
                      "url": "${{ github.event.pull_request.html_url }}",
                      "action_id": "actionId-1"
                    }
                  ]
                },
                {
                  "type": "divider"
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_THREAD_ID: ${{ needs.set-slack-thread.outputs.SLACK_THREAD_ID.slack_msg_id }}
          
  pr-approved_alert:
    needs: set-slack-thread
    if: github.event.review.state == 'APPROVED'
    runs-on: ubuntu-latest
    steps:

      - name: Set assignee variables
        id: set-vars
        run: |
          echo "REVIEWER_SLACK_ID=${{ env[github.event.sender.login] }}" >> $GITHUB_ENV
          echo "ASSIGNEE_SLACK_ID=${{ env[github.event.pull_request.assignee.login] }}" >> $GITHUB_ENV

      - name: Set reviewer and reviewee nickname
        id: set-nicks
        run: |
          echo "REVIEWER_NICKNAME=${{ env[format('{0}', env.REVIEWER_SLACK_ID)] }}" >> $GITHUB_ENV
          echo "ASSIGNEE_NICKNAME=${{ env[format('{0}', env.ASSIGNEE_SLACK_ID)] }}" >> $GITHUB_ENV

      - name: pr reviewerÍ∞Ä Approve ÌïòÎ©¥ slack ÏïåÎ¶º Î≥¥ÎÉÑ
        uses: slackapi/slack-github-action@v1.24.0
        with:
          channel-id: ${{ secrets.TASK_COMPLETE_SLACK_CHANNEL_ID }}
          payload: |
            {
              "thread_ts": "${{ env.SLACK_THREAD_ID }}",
              "blocks": [
                {
                  "type": "divider"
                },
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üèÅ PR ÏäπÏù∏ üèÅ",
                    "emoji": true
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "plain_text",
                      "text": "from.",
                      "emoji": true
                    },
                    {
                      "type": "image",
                      "image_url": "${{ github.event.sender.avatar_url }}",
                      "alt_text": ""
                    },
                    {
                      "type": "plain_text",
                      "text": "${{ env.REVIEWER_NICKNAME }}",
                      "emoji": true
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "<@${{ env.ASSIGNEE_SLACK_ID }}>Îãò! \nÎ¶¨Î∑∞Ïñ¥ÏóêÍ≤å ÏäπÏù∏ÏùÑ Î∞õÏïòÏñ¥Ïöî!"
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "üöÄ *PR Ï†úÎ™©:*\n${{ github.event.pull_request.title }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "üïπÔ∏è Merge ÌïòÎü¨ Í∞ÄÍ∏∞ üïπÔ∏è",
                        "emoji": true
                      },
                      "value": "PR_LINK",
                      "url": "${{ github.event.pull_request.html_url }}",
                      "action_id": "actionId-1"
                    }
                  ]
                },
                {
                  "type": "divider"
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_THREAD_ID: ${{ needs.set-slack-thread.outputs.SLACK_THREAD_ID.slack_msg_id }}
